---
import "../styles/global.css";
import { ClientRouter } from "astro:transitions";
import { SITE } from "@consts";

import "@fontsource/geist-sans/100.css";
import "@fontsource/geist-sans/200.css";
import "@fontsource/geist-sans/300.css";
import "@fontsource/geist-sans/400.css";
import "@fontsource/geist-sans/500.css";
import "@fontsource/geist-sans/600.css";
import "@fontsource/geist-sans/700.css";
import "@fontsource/geist-sans/800.css";
import "@fontsource/geist-sans/900.css";
import "@fontsource/geist-mono/100.css";
import "@fontsource/geist-mono/200.css";
import "@fontsource/geist-mono/300.css";
import "@fontsource/geist-mono/400.css";
import "@fontsource/geist-mono/500.css";
import "@fontsource/geist-mono/600.css";
import "@fontsource/geist-mono/700.css";
import "@fontsource/geist-mono/800.css";
import "@fontsource/geist-mono/900.css";

interface Props {
  title: string;
  description: string;
  image?: string;
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const { title, description, image = "/astro-micro.jpg" } = Astro.props;
const personJsonLd = {
  "@context": "https://schema.org",
  "@type": "Person",
  name: "Prabhat Kumar Sahu",
  alternateName: ["Prabhat Kumar", "Prabhat", "thecaffeinedev", "caffeinedev"],
  url: Astro.site?.toString(),
  sameAs: [
    "https://x.com/thecaffeinedev",
    "https://github.com/thecaffeinedev",
    "https://www.linkedin.com/in/prabhat-kumar-sahu-b9a53674/",
  ],
  jobTitle: "Software Engineer",
  email: SITE.EMAIL ? `mailto:${SITE.EMAIL}` : undefined,
};
---

<script is:inline>
  (function() {
    const theme = localStorage.getItem('theme');
    const isDark = theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches);
    
    if (isDark) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  })();
</script>

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- Favicons -->
<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
<link rel="manifest" href="/favicon/site.webmanifest" />
<link rel="shortcut icon" href="/favicon/favicon.ico" />
<meta name="msapplication-TileColor" content="#000000" />
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff" />
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000" />

<link
  rel="icon"
  href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”¬</text></svg>"
/>
<meta name="generator" content={Astro.generator} />

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />
<script type="application/ld+json">
  {JSON.stringify(personJsonLd)}
</script>

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={new URL(image, Astro.url)} />

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={new URL(image, Astro.url)} />

<!-- PageFind -->
<link href="/pagefind/pagefind-ui.css" rel="stylesheet" />
<script is:inline src="/pagefind/pagefind-ui.js"></script>

<!-- Google Analytics -->
{SITE.GA_MEASUREMENT_ID && (
  <>
    <script is:inline async src={`https://www.googletagmanager.com/gtag/js?id=${SITE.GA_MEASUREMENT_ID}`}></script>
    <script is:inline define:vars={{ GA_MEASUREMENT_ID: SITE.GA_MEASUREMENT_ID }}>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', GA_MEASUREMENT_ID);
    </script>
    
    <!-- Track view transitions as page views -->
    <script is:inline define:vars={{ GA_MEASUREMENT_ID: SITE.GA_MEASUREMENT_ID }}>
      document.addEventListener('astro:after-swap', () => {
        if (typeof gtag !== 'undefined') {
          gtag('config', GA_MEASUREMENT_ID, {
            page_path: window.location.pathname,
          });
        }
      });
    </script>
  </>
)}

<ClientRouter />



<script is:inline>

function init() {
  preloadTheme();
  updateThemeToggle();

  const backToTop = document.getElementById("back-to-top");
  backToTop?.addEventListener("click", (event) => scrollToTop(event));

  const backToPrev = document.getElementById("back-to-prev");
  backToPrev?.addEventListener("click", () => window.history.back());

  // Single theme toggle button
  const themeToggle = document.getElementById("theme-toggle");
  themeToggle?.addEventListener("click", () => {
    const isDark = document.documentElement.classList.contains("dark");
    toggleTheme(!isDark);
    localStorage.setItem("theme", isDark ? "light" : "dark");
    updateThemeToggle();
  });

  document.addEventListener("scroll", onScroll);
  addCopyCodeButtons();
  animate();
}

function updateThemeToggle() {
  const isDark = document.documentElement.classList.contains("dark");
  const lightIcon = document.getElementById("theme-toggle-light-icon");
  const darkIcon = document.getElementById("theme-toggle-dark-icon");
  
  if (isDark) {
    lightIcon?.classList.remove("hidden");
    lightIcon?.classList.add("block");
    darkIcon?.classList.remove("block");
    darkIcon?.classList.add("hidden");
  } else {
    lightIcon?.classList.remove("block");
    lightIcon?.classList.add("hidden");
    darkIcon?.classList.remove("hidden");
    darkIcon?.classList.add("block");
  }
}

function animate() {
  const animateElements = document.querySelectorAll(".animate");
  animateElements.forEach((element, index) => {
    setTimeout(() => {
      element.classList.add("show");
    }, index * 100);
  });
}

function onScroll() {
  if (window.scrollY > 0) {
    document.documentElement.classList.add("scrolled");
  } else {
    document.documentElement.classList.remove("scrolled");
  }
}

function scrollToTop(event) {
  event.preventDefault();
  window.scrollTo({
    top: 0,
    behavior: "smooth",
  });
}

function toggleTheme(dark) {
  const css = document.createElement("style");
  css.appendChild(
    document.createTextNode(
      `* {
         -webkit-transition: none !important;
         -moz-transition: none !important;
         -o-transition: none !important;
         -ms-transition: none !important;
         transition: none !important;
      }`
    )
  );

  document.head.appendChild(css);

  if (dark) {
    document.documentElement.classList.add("dark");
  } else {
    document.documentElement.classList.remove("dark");
  }

  window.getComputedStyle(css).opacity;
  document.head.removeChild(css);
  setGiscusTheme();
}

function preloadTheme() {
  const userTheme = localStorage.theme;
  
  if (userTheme === "light" || userTheme === "dark") {
    toggleTheme(userTheme === "dark");
  } else {
    // Default to system preference
    const isDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    toggleTheme(isDark);
  }
  
  // Force Safari to recognize the theme immediately
  if (typeof document !== 'undefined') {
    requestAnimationFrame(() => {
      updateThemeToggle();
    });
  }
}

function addCopyCodeButtons() {
  let copyButtonLabel = "ðŸ“‹";
  let codeBlocks = Array.from(document.querySelectorAll("pre"));

  async function copyCode(codeBlock, copyButton) {
    const codeText = codeBlock.innerText;
    const buttonText = copyButton.innerText;
    const textToCopy = codeText.replace(buttonText, "");

    await navigator.clipboard.writeText(textToCopy);
    copyButton.innerText = "âœ…";

    setTimeout(() => {
      copyButton.innerText = copyButtonLabel;
    }, 2000);
  }

  for (let codeBlock of codeBlocks) {
    const wrapper = document.createElement("div");
    wrapper.style.position = "relative";

    const copyButton = document.createElement("button");
    copyButton.innerText = copyButtonLabel;
    copyButton.classList = "copy-code";

    codeBlock.setAttribute("tabindex", "0");
    codeBlock.appendChild(copyButton);

    codeBlock.parentNode.insertBefore(wrapper, codeBlock);
    wrapper.appendChild(codeBlock);

    copyButton?.addEventListener("click", async () => {
      await copyCode(codeBlock, copyButton);
    });
  }
}

const setGiscusTheme = () => {
  const giscus = document.querySelector(".giscus-frame");
  const isDark = document.documentElement.classList.contains("dark");

  if (giscus) {
    const url = new URL(giscus.src);
    url.searchParams.set("theme", isDark ? "dark" : "light");
    giscus.src = url.toString();
  }
};

document.addEventListener("DOMContentLoaded", () => init());
document.addEventListener("astro:after-swap", () => init());
preloadTheme();
</script>
